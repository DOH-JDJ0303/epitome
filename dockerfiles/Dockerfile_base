# -----------------------------
# Build Stage: EPITOME Env
# -----------------------------
FROM python:3.11-slim-bullseye as app

ARG SOFTWARENAME_VER="1.0.0"
ARG SOURMASH_VER="v4.9.2"

LABEL base.image="python:3.11-slim-bullseye"
LABEL software="EPITOME"
LABEL software.version="${SOFTWARENAME_VER}"
LABEL description="Dependencies for the EPITOME pipeline"
LABEL website="https://github.com/DOH-JDJ0303/epitome"
LABEL license="Apache 2.0"
LABEL maintainer="Jared Johnson"
LABEL maintainer.email="jared.johnson@doh.wa.gov"

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    libatlas-base-dev \
    gfortran \
    liblapack-dev \
    libblas-dev \
    pkg-config \
    libfreetype6-dev \
    libpng-dev \
    llvm-dev \
    libclang-dev \
    git \
    wget \
    curl \
    pip \
    procps \
    jq \
    unzip \
    gawk \
    ca-certificates \
    libcurl4-gnutls-dev \
 && apt-get clean \
 && rm -rf /var/lib/apt/lists/*

# Upgrade pip and install Python packages
RUN python3 -m pip install --no-cache-dir --upgrade pip \
 && python3 -m pip install --no-cache-dir maturin 'matplotlib>=3.3' scikit-learn

# Install Rust for sourmash
ENV CARGO_HOME=/root/.cargo \
    RUSTUP_HOME=/root/.rustup
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | bash -s -- -y

ENV PATH="$CARGO_HOME/bin:$PATH"

# Install sourmash from source
RUN git clone --branch "${SOURMASH_VER}" https://github.com/sourmash-bio/sourmash.git /opt/sourmash \
 && cd /opt/sourmash \
 && python3 -m pip install --no-cache-dir -e .[dev]

# Install NCBI Entrez Direct (EDirect)
RUN mkdir -p /root/edirect \
 && bash -c "$(wget -qO- https://ftp.ncbi.nlm.nih.gov/entrez/entrezdirect/install-edirect.sh)" \
 && chmod +x /root/edirect/*

# Install NCBI Datasets CLI tools
RUN mkdir -p /root/bin \
 && wget -q https://ftp.ncbi.nlm.nih.gov/pub/datasets/command-line/v2/linux-amd64/datasets -O /root/bin/datasets \
 && wget -q https://ftp.ncbi.nlm.nih.gov/pub/datasets/command-line/v2/linux-amd64/dataformat -O /root/bin/dataformat \
 && chmod +x /root/bin/datasets /root/bin/dataformat

# Set environment
ENV PATH="/usr/local/bin:/root/.cargo/bin:/root/edirect:/root/bin:$PATH" \
    LC_ALL=C

# Default workdir
WORKDIR /data

# -----------------------------
# Test Stage
# -----------------------------
FROM app as test
WORKDIR /test
RUN sourmash --version \
 && datasets --version \
 && esearch -db nucleotide -query 'Lomovskayavirus[Organism] AND "complete sequence"[Title]'