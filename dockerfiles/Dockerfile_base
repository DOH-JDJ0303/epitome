# -----------------------------
# Build Stage: EPITOME Env
# -----------------------------
FROM python:3.11-slim-bullseye AS app

ARG SOFTWARENAME_VER="2.0.0"
ARG SOURMASH_VER="4.9.2"  # use PyPI version (no leading 'v')

LABEL org.opencontainers.image.base.name="python:3.11-slim-bullseye" \
      org.opencontainers.image.title="EPITOME" \
      org.opencontainers.image.version="${SOFTWARENAME_VER}" \
      org.opencontainers.image.description="Dependencies for the EPITOME pipeline" \
      org.opencontainers.image.url="https://github.com/DOH-JDJ0303/epitome" \
      org.opencontainers.image.licenses="Apache-2.0" \
      org.opencontainers.image.authors="Jared Johnson <jared.johnson@doh.wa.gov>"

ENV DEBIAN_FRONTEND=noninteractive \
    LC_ALL=C.UTF-8 \
    LANG=C.UTF-8 \
    PIP_NO_CACHE_DIR=1

SHELL ["/bin/bash", "-o", "pipefail", "-c"]

# System deps (minimal, runtime-friendly)
RUN apt-get update && apt-get install -y --no-install-recommends \
      build-essential \
      libatlas-base-dev gfortran liblapack-dev libblas-dev \
      pkg-config \
      libfreetype6-dev libpng-dev \
      git curl wget ca-certificates \
      procps jq unzip gawk \
      perl gzip less xz-utils bzip2 \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Python deps (no Rust toolchain needed if we use wheels)
RUN python -m pip install --upgrade pip && \
    python -m pip install \
      "matplotlib>=3.3" \
      scikit-learn \
      sourmash==${SOURMASH_VER}

# NCBI Entrez Direct (EDirect)
RUN curl -fsSL https://ftp.ncbi.nlm.nih.gov/entrez/entrezdirect/install-edirect.sh | bash
ENV PATH="/root/edirect:${PATH}"

# NCBI Datasets CLI + dataformat
RUN install -d -m 0755 /usr/local/bin && \
    curl -fsSL -o /usr/local/bin/datasets    https://ftp.ncbi.nlm.nih.gov/pub/datasets/command-line/v2/linux-amd64/datasets && \
    curl -fsSL -o /usr/local/bin/dataformat  https://ftp.ncbi.nlm.nih.gov/pub/datasets/command-line/v2/linux-amd64/dataformat && \
    chmod +x /usr/local/bin/datasets /usr/local/bin/dataformat

WORKDIR /data

# -----------------------------
# Test Stage
# -----------------------------
FROM app AS test
WORKDIR /test
# quick sanity checks
RUN sourmash --version && datasets --version && esearch -db nucleotide -query 'Lomovskayavirus[Organism] AND "complete sequence"[Title]'
